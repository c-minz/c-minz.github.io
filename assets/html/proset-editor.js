function checkAndThrowWarningIfLarge(e,t=!1){if((t&&e>LargePosetWarning_links||!t&&e>LargePosetWarning_elements)&&!LargePosetWarningError_isShowing)throw new LargePosetWarningError(e,t)}function showError(e,t=!1){finishProgress();const n=document.getElementById("msgError");n.innerText=e,n.className=t?"alert alert-danger":"alert alert-warning",n.hidden=!1,n.focus(),isBusy=!1}function hideLastError(){document.getElementById("msgError").hidden=!0,WarningError_isShowing=!1,LargePosetWarningError_isShowing=!1}function startProgress(){document.getElementById("prgSymbol").className="progress-symbol busy",document.getElementById("prgBar").ariaValueNow="0",document.getElementById("prgBarValue").style="width: 0%",isBusy=!0}function stepProgress(e=0){let t=Math.max(0,Math.min(Math.round(100*e),100)).toString();document.getElementById("prgBar").ariaValueNow=t,document.getElementById("prgBarValue").style="width: "+t+"%"}function finishProgress(){document.getElementById("prgSymbol").className="progress-symbol",document.getElementById("prgBar").ariaValueNow="0",document.getElementById("prgBarValue").style="width: 0%",isBusy=!1}function initializeEditor(){document.getElementById("msgJavascript").hidden=!0,selectInputType(),updateWidth(),document.getElementById("butRemoveMemoryEntry").disabled=!0,document.getElementById("butClearMemory").disabled=!0,document.getElementById("butCopyMemoryEntry").disabled=!0,document.getElementById("butCopyMemory").disabled=!0,document.getElementById("butCreateInsert").disabled=!0,document.getElementById("butRevise").disabled=!0,document.getElementById("butMemorize").disabled=!0,document.getElementById("butUndo").disabled=!0,document.getElementById("butRedo").disabled=!0,document.getElementById("butRaiseOffset").disabled=!0,document.getElementById("butLowerOffset").disabled=!0,document.getElementById("butReflect").disabled=!0,document.getElementById("butOpposite").disabled=!0,document.getElementById("butOptimize").disabled=!0,document.getElementById("butTo2Order").disabled=!0,document.getElementById("butAddElement").disabled=!0;const e=document.getElementById("butRemoveElement");e.disabled=!0,e.className="btn btn-secondary";document.getElementById("txtSelection").value="";const t=document.getElementById("butLink");t.disabled=!0,t.className="btn btn-secondary",document.getElementById("txtLinking").value="",document.getElementById("butSwapLeft").disabled=!0,updateSettingsButton("ShowLabels",!1,!1),updateSettingsButton("ShowCross",!1,!1),updateSettingsButton("ShowGrid",!1,!1),document.getElementById("lblPermutation").innerHTML="0 elements on 0 layers:",document.getElementById("txtPermutation").value="",document.getElementById("lblLinks").innerHTML="0 links:",document.getElementById("txtLinks").value="";const n=document.getElementById("lblRemovedLinks");n.className="input-group-text",n.innerHTML="0 removed links:",document.getElementById("txtRemovedLinks").value="";const r=["pcauset","rcauset","causet"];for(let e=0;e<r.length;e++)document.getElementById("txtExport_"+r[e]).value="",document.getElementById("frmExport_"+r[e]).hidden=!0;document.getElementById("txtExportArray").value="",finishProgress()}function selectInputType(){hideLastError();let e=document.getElementById("selInputType").value;document.getElementById("frmInputPredefined").hidden="predefined"!=e,document.getElementById("frmInputPermutation").hidden=!e.endsWith("causet"),document.getElementById("frmInputRemovedLinks").hidden="rcauset"!=e,document.getElementById("frmInputLinks").hidden="causet"!=e,document.getElementById("frmInputLatex").hidden="latex"!=e,document.getElementById("frmInputMemory").hidden="memory"!=e,document.getElementById("frmInputCoveringList").hidden="coveringslist"!=e,document.getElementById("frmInputMatrix").hidden="matrix"!=e}function updateWidth(){const e=4;let t=document.getElementById("cnvPoset").width,n=document.getElementById("cnvPosetContainer").clientWidth,r=document.getElementById("selRelativeCanvasSize").value,i=document.getElementById("selAbsoluteCanvasSize").value;return"fill"==r?"unbounded"!=i?n=parseInt(i,10):n-=e:(n=Math.floor(r/100*n)-e,"unbounded"!=i&&(n=Math.min(n,parseInt(i,10)))),n!==t&&(document.getElementById("cnvPoset").width=n,document.getElementById("cnvPoset").height=n,!0)}function toggleReleaseNotes(e){const t=document.getElementById("release_notes_"+e);"accordion-collapse show"==t.className?t.className="accordion-collapse collapse":t.className="accordion-collapse show"}function parseIntNotNaN(e){let t=parseInt(e.trim(),10);if(isNaN(t))throw 0==e.length&&(e="(empty)"),new SyntaxError("The value "+e+" cannot be converted to an integer!");return t}function parseLink(e){let t=e.indexOf("/");if(t<0)throw new SyntaxError("Each link has to be of the format 'number/number'.");let n,r=e.indexOf("/",t+1),i=parseIntNotNaN(e.substr(0,t)),o=!1,s="";if(r<0?n=parseIntNotNaN(e.substr(t+1)):(n=parseIntNotNaN(e.substr(t+1,r-t-1)),o=!0,s=e.substr(r+1)),i===n)throw new SyntaxError("An element cannot be linked to itself.");return n<i?o?[n,i,s]:[n,i]:o?[i,n,s]:[i,n]}function parsePermutation(e,t){let n;n="string"==typeof e?e.split(",").map(parseIntNotNaN):e;let r=n.length;if(r<1)throw new RangeError("The poset has to have at least one element!");let i=n[0],o=n[0];for(let e=1;e<r;e++){let t=n[e];t<i&&(i=t),t>o&&(o=t)}let s=Math.max(r,o-i+1);t&&checkAndThrowWarningIfLarge(s);const l=new Array(s).fill(0);for(let e=0;e<r;e++){let t=n[e]-i;l[t]=l[t]+1}if(r!=s||-1!=l.indexOf(0)){let e=0,t=[];for(let n=0;n<s;n++)if(1!=l[n]){if(e++,e>3)break;let r=n+i;0==l[n]?t.push("The element "+r.toString()+" is missing!"):t.push("The element "+r.toString()+" appears "+l[n]+" times!")}let n=t.join(" ");throw e>3&&(n+=" And more errors ..."),new RangeError(n)}for(let e=0;e<r;e++)n[e]=n[e]-i;return[n,i]}function parseLinks(e,t,n){if(0==e.length)return[[],[]];let r;r="string"==typeof e?e.split(",").map(parseLink):e;const i=[],o=[];for(let e=0;e<r.length;e++){let s=r[e][0]-t,l=r[e][1]-t;s<0||l>n||(r[e].length>2?o.push([s,l]):i.push([s,l]))}return[i,o]}function findEndgroup(e,t,n="{",r="}"){let i=e.indexOf(r,t);if(r<0)return-1;let o=e.indexOf(n,t);return o<t||o>i?i:(i=findEndgroup(e,o+1,n,r),i<0?-1:findEndgroup(e,i+1,n,r))}function removeGroups(e,t="{",n="}"){let r=e.indexOf(t);if(r<0)return e;let i=findEndgroup(e,r+1,t,n);return i<0?e:removeGroups(e=e.substring(0,r)+e.substring(i+1),t,n)}function initializeArray(e,t){const n=new Array(e);for(let r=0;r<e;r++)n[r]=t;return n}function initializeLinkList(e){const t=new Array(e);for(let n=0;n<e;n++)t[n]=[];return t}function remapLinkList(e,t){let n=e.length;const r=initializeLinkList(n);for(let i=0;i<n;i++){let n=e[i],o=t[i];for(let e=0;e<n.length;e++){let i=t[n[e]],s=Math.min(o,i),l=Math.max(o,i);r[s].push(l)}}return r}function findCoveredElements(e,t){const n=[];if(t>=e.length)return n;for(let r=0;r<t;r++)e[r].includes(t)&&n.push(r);return n}function raiseElements(e,t,n){for(let r=0;r<e.length;r++)e[r]>=t&&(e[r]=e[r]+n)}function raiseLinkedElements(e,t,n){for(let r=0;r<e.length;r++)raiseElements(e[r],t,n)}function insertLinks(e,t,n,r,i){raiseLinkedElements(e,t+1,n.length-1),raiseLinkedElements(n,0,t);const o=findCoveredElements(e,t),s=e[t];let l=e.slice(0,t).concat(n,e.slice(t+1));for(let e=0;e<o.length;e++){let n=o[e],i=l[n].indexOf(t);i>=0&&l[n].splice(i,1),l[n]=l[n].concat(r)}for(let e=0;e<i.length;e++){let t=i[e];l[t]=l[t].concat(s)}return l}function getElementString(e){return(e+poset.offset).toString()}function getAddedLinkTargetString(e){return getElementString(e)+"/"}function createNew(){if(isBusy)return;let e=generate();e&&(poset=e,updateSelectionBounds(),setSelection(NaN),addUndoStep(),window.location.href="#edit","coveringslist"==document.getElementById("selInputType").value&&optimize(),document.getElementById("butRevise").disabled=!1,document.getElementById("butMemorize").disabled=!1,document.getElementById("butRaiseOffset").disabled=!1,document.getElementById("butLowerOffset").disabled=!1,document.getElementById("butReflect").disabled=!1,document.getElementById("butOpposite").disabled=!1,document.getElementById("butAddElement").disabled=!1)}function createInsert(){if(isBusy)return;let e=getSelection();if(isNaN(e)){return void showError(new TypeError("There is no element selected! Select an element in the diagram for an insert.").toString())}let t=generate();t&&(poset.insert(e,t),updateSelectionBounds(),setSelection(NaN),addUndoStep())}function generate(){let e,t=document.getElementById("selInputType").value,n=removeGroups(document.getElementById("txtInputPermutation").value),r="",i=!1;try{"predefined"==t?e=getPredefined():"pcauset"==t?e=new Poset(n,"",!0):"rcauset"==t?e=new Poset(n,removeGroups(document.getElementById("txtInputRemovedLinks").value),!0):"causet"==t?e=new Poset(n,removeGroups(document.getElementById("txtInputLinks").value),!1):"latex"==t?e=getFromLatexMacro(document.getElementById("txtInputLatex").value):"coveringslist"==t?e=getFromCoveringList(document.getElementById("txtInputCoveringList").value):"memory"==t&&(e=getFromMemory(document.getElementById("selInputMemory").value)),r=e.error,i=e.hasWarning}catch(e){r=e.toString(),i=e instanceof WarningError}return r?(showError(r,i),0):e}function getPredefined(){let e=document.getElementById("selInputPredefinedType").value,t=parseInt(document.getElementById("txtInputOrder").value,10);if(isNaN(t)||t<1)throw new RangeError("The value for 'n' has to be a strictly positive integer.");if("chain"==e)return getPredefined_chain(t);if("antichain"==e)return getPredefined_antichain(t);if("random"==e)return getPredefined_random(t);if("fence"==e)return getPredefined_fence(t);if("crown"==e)return getPredefined_crown(t);if("polygon"==e)return getPredefined_polygon(t);if("2lattice"==e)return getPredefined_2lattice(t);throw new TypeError("The poset type '"+e+"' is not implemented.")}function getPredefined_chain(e){checkAndThrowWarningIfLarge(e);const t=new Array(e);for(let n=0;n<e;)t[n]=++n;return new Poset(t,[],!0,!1)}function getPredefined_antichain(e){checkAndThrowWarningIfLarge(e);const t=new Array(e);for(let n=0;n<e;n++)t[n]=e-n;return new Poset(t,[],!0,!1)}function getPredefined_random(e){checkAndThrowWarningIfLarge(e);const t=new Array(e);for(let n=0;n<e;)t[n]=++n;for(let n=e-1;n>0;n--){let e=Math.floor(Math.random()*(n+1)),r=t[n];t[n]=t[e],t[e]=r}return new Poset(t,[],!0,!1)}function getPredefined_fence(e){if(checkAndThrowWarningIfLarge(e),1===e)return new Poset([1],[],!0);const t=new Array(e);t[0]=e-1;for(let n=e%2;n<e;n++)t[n]=Math.max(1,e-n-2),t[++n]=Math.min(e-n+2,e);return new Poset(t,[],!0,!1)}function getPredefined_crown(e){if(1===e)throw new RangeError("Crown posets only exist for n > 1.");checkAndThrowWarningIfLarge(2*e),checkAndThrowWarningIfLarge(e*(e-1),!0);const t=[e+1];for(let n=e-1;n>=2;n--)t.push(n);t.push(2*e,1);for(let n=2*e-1;n>=2+e;n--)t.push(n);t.push(e);const n=[];for(let t=2;t<e;t++)n.push([t,2*e-t+1]);return new Poset(t,n,!0,!1)}function getPredefined_polygon(e){if(checkAndThrowWarningIfLarge(2*e+2),checkAndThrowWarningIfLarge(4*e,!0),1===e)return new Poset([0,1,2,3],[],!0);if(2===e)return new Poset([0,2,1,4,3,5],[],!0);const t=[0,2*(e-1),2*(e-2),2*e];for(let n=3;n<e;n++)t.push(2*(e-n),2*(e-n+3)-1);t.push(1,5,3,2*e+1);const n=[];let r=2*e-4;for(let e=2;e<=r;e+=2)n.push([e,e+3]);return new Poset(t,n,!0,!1)}function getPredefined_2lattice(e){let t=e*e;checkAndThrowWarningIfLarge(t),checkAndThrowWarningIfLarge(2*(t-e),!0);const n=new Array(t);for(let r=0;r<t;r++)n[r]=Math.floor(r*e/t)+r*e%t+1;return new Poset(n,[],!0,!1)}function getFromLatexMacro(e){let t=(e=e.trim()).startsWith("\\drawpcauset{")||e.startsWith("\\pcauset{")||e.startsWith("\\pcauset[")||e.startsWith("\\pcausetL{")||e.startsWith("\\pcausetL[")||e.startsWith("\\pcausetP{")||e.startsWith("\\pcausetP[")||e.startsWith("\\pcausetX{")||e.startsWith("\\pcausetX["),n=e.startsWith("\\drawrcauset{")||e.startsWith("\\rcauset{")||e.startsWith("\\rcauset[")||e.startsWith("\\rcausetL{")||e.startsWith("\\rcausetL[")||e.startsWith("\\rcausetP{")||e.startsWith("\\rcausetP[")||e.startsWith("\\rcausetX{")||e.startsWith("\\rcausetX["),r=e.startsWith("\\drawcauset{")||e.startsWith("\\causet{")||e.startsWith("\\causet[")||e.startsWith("\\causetL{")||e.startsWith("\\causetL[")||e.startsWith("\\causetP{")||e.startsWith("\\causetP[")||e.startsWith("\\causetX{")||e.startsWith("\\causetX[");if(!t&&!n&&!r)throw new SyntaxError("This value cannot be processed. Supported macros are: \\pcauset, \\rcauset and \\causet each followed by a square bracket [ or brace {. \nSupported macros are also: \\drawpcauset, \\drawrcauset and \\drawcauset that must be followed by a brace {.");let i=e.indexOf("{")+1;if(i<1)throw new SyntaxError("The LaTeX macro has to have a first argument starting with an opening brace {.");let o=findEndgroup(e,i);if(o<i)throw new SyntaxError("The first argument has no closing brace }.");if(t)return new Poset(removeGroups(e.slice(i,o)),[],!0);let s=e.indexOf("{",o)+1;if(s<1)throw new SyntaxError("The LaTeX macro has to have an second argument starting with an opening brace {.");let l=findEndgroup(e,s);if(l<s)throw new SyntaxError("The second argument has no closing brace }.");return new Poset(removeGroups(e.substring(i,o)),removeGroups(e.substring(s,l)),n)}function getFromMemory(e){if(!e)throw new TypeError("There is no memory entry! First create a diagram from another input type and add it to the memory.");return getFromLatexMacro(e)}function updateSelectionBounds(){let e=poset.offset,t=poset.count()-1+poset.offset;document.getElementById("txtSelection").min=e.toString(),document.getElementById("txtSelection").max=t.toString()}function getSelection(){let e=document.getElementById("txtSelection").value,t=parseInt(e.trim(),10)-poset.offset;return t>=0&&t<poset.count()?t:NaN}function setSelection(e){let t="",n=poset.count();const r=document.getElementById("butSwapLeft");if(r.disabled=!0,e>=0&&e<n){t=String(e+poset.offset);let i=poset.permutation.indexOf(e);r.disabled=i>n-2||poset.permutation[i+1]!=e-1}const i=document.getElementById("butRemoveElement");i.disabled=""==t||1==n,i.disabled?i.className="btn btn-secondary":i.className="btn btn-outline-danger",document.getElementById("butCreateInsert").disabled=""==t;document.getElementById("txtSelection").value=t,document.getElementById("txtLinking").value="";const o=document.getElementById("butLink");o.className="btn btn-secondary",o.disabled=!0,linkable=!1,redrawPoset(),updateExport()}function resetSelection(){isBusy||setSelection(getSelection())}function getLinkingSelection(){let e=document.getElementById("txtLinking").value,t=parseInt(e.trim(),10)-poset.offset;return t>=0&&t<poset.count()?t:NaN}function setLinkingSelection(e){let t="";e>=0&&e<poset.count()&&(t=String(e+poset.offset)),document.getElementById("txtLinking").value=t;const n=document.getElementById("butLink");n.disabled=""==t,n.disabled?n.className="btn btn-secondary":n.className="btn btn-outline-primary",redrawPoset()}function initializeCanvas(e,t){e.setTransform(1,0,0,1,0,0),e.clearRect(0,0,e.canvas.width,e.canvas.height),e.beginPath();let n=e.canvas.height/t/Math.sqrt(2);e.scale(n,-n),e.translate(t/Math.sqrt(2),-Math.sqrt(2)*t),e.rotate(45*Math.PI/180)}function drawCross(e,t,n){e.strokeStyle=selection_cross_color,e.lineWidth=1,e.beginPath(),e.moveTo(n+.5,0),e.lineTo(n+.5,t);for(let r=0;r<t;r++)poset.permutation[r]==n&&(e.moveTo(0,r+.5),e.lineTo(t,r+.5));e.stroke()}function drawHoveredTile(e,t,n){let r=poset.permutation.indexOf(t),i=hover[0],o=hover[1];-1===n?(e.fillStyle=relocation_color,e.beginPath(),e.ellipse(i+.5,o+.5,event_hover_size,event_hover_size,0,0,2*Math.PI),e.ellipse(t+.5,r+.5,event_hover_size,event_hover_size,0,0,2*Math.PI),e.fill()):n!=t&&(e.fillStyle=selection_color,e.beginPath(),e.ellipse(i+.5,o+.5,event_hover_size,event_hover_size,0,0,2*Math.PI),e.fill())}function drawGrid(e,t){e.strokeStyle="#c0c0c0",e.lineWidth=.05;for(let n=0;n<=t;n++)e.beginPath(),e.moveTo(0,n),e.lineTo(t,n),e.stroke(),e.beginPath(),e.moveTo(n,0),e.lineTo(n,t),e.stroke()}function drawLinks(e,t,n,r){let i=poset.permutation.indexOf(n),o=poset.permutation.indexOf(r);for(let i=0;i<t;i++){let t=poset.links[i];for(let o=0;o<t.length;o++){let s=t[o];e.lineWidth=link_width,e.strokeStyle=link_color,n===i&&r===s&&-1===linkable&&(e.lineWidth=linking_width,e.strokeStyle=event_linking_color),e.beginPath(),e.moveTo(i+.5,poset.permutation.indexOf(i)+.5),e.lineTo(s+.5,poset.permutation.indexOf(s)+.5),e.stroke()}}!isNaN(n)&&!isNaN(r)&&!poset.links[n].includes(r)&&(e.lineWidth=link_width,e.strokeStyle=unlinked_color,e.beginPath(),e.moveTo(n+.5,i+.5),e.lineTo(r+.5,o+.5),e.stroke())}function drawEventNodes(e,t,n,r,i,o){let s=poset.permutation.indexOf(r);for(let s=0;s<t;s++){let t=poset.permutation[s];e.fillStyle=event_color,o!=n&&o===t?e.fillStyle=event_hover_color:i&&-1===o&&t===n?e.fillStyle=selection_cross_color:t===r?e.fillStyle=event_linking_color:t===n&&(e.fillStyle=selection_color),e.beginPath(),e.ellipse(t+.5,s+.5,event_size,event_size,0,0,2*Math.PI),e.fill()}isNaN(r)||i&&r==hover[0]&&s==hover[1]||(e.fillStyle=event_color,e.beginPath(),e.ellipse(r+.5,s+.5,event_linking_size,event_linking_size,0,0,2*Math.PI),e.fill())}function drawLabels(e,t,n,r){let i=e.width/n/2;t.setTransform(1,0,0,1,0,0),t.translate(e.width/2,e.height),t.font=(e.width/n/3).toString()+"px Arial",t.textAlign="right";for(let e=0;e<n;e++){let n=poset.permutation[e],o=(n-e-.5)*i,s=(n+e+.2)*i;t.fillStyle=event_color,n===r&&(t.fillStyle=selection_color),t.beginPath(),t.fillText(n+poset.offset,o,-s)}}function redrawPoset(){if(isBusy)return;let e=document.getElementById("cnvPoset"),t=e.getContext("2d"),n=getSelection(),r=getLinkingSelection(),i=poset.count();initializeCanvas(t,i),isShowingCross&&drawCross(t,i,n);let o=-1,s=2==hover.length;if(s){poset.permutation.indexOf(hover[0])===hover[1]&&(o=hover[0]),drawHoveredTile(t,n,o)}isShowingGrid&&drawGrid(t,i),drawLinks(t,i,n,r),drawEventNodes(t,i,n,r,s,o),isShowingLabels&&drawLabels(e,t,i,n)}function addUndoStep(){undoindex<undosteps.length-1&&undosteps.splice(undoindex+1,undosteps.length-undoindex-1);const e=poset.getPermutationString();e.length>0&&(undosteps.length>=undosteps_max&&undosteps.splice(0,undosteps_max-undosteps.length+1),undosteps.push([e,strAllLinks])),undoindex=undosteps.length-1,document.getElementById("butUndo").disabled=undoindex<=0,document.getElementById("butRedo").disabled=!0}function resetToUndoStep(e){if(isBusy)return;let t=undoindex+e;if(t<0||t>=undosteps.length)return;let n=new Poset(undosteps[t][0],undosteps[t][1],0===undosteps[t][1].length);n.error?showError(n.error,n.hasWarning):(poset=n,undoindex=t,document.getElementById("butUndo").disabled=undoindex<=0,document.getElementById("butRedo").disabled=undoindex>=undosteps.length-1,updateSelectionBounds(),setSelection(NaN))}function updateHoveredTile(e,t){let n=document.getElementById("cnvPoset"),r=n.getBoundingClientRect(),i=poset.count(),o=n.width/i;e=e-r.left-n.width/2,y_u=-t+r.top+n.height/2,y_v=-t+r.bottom-n.height/2;let s=Math.round((y_u+e)/o+(i+1)/2)-1,l=Math.ceil((y_v-e)/o+i/2)-1;if(s<0||s>=i||l<0||l>=i)return hover.length>0&&(hover=[],!0);let a=poset.permutation[l],d=s!=a,u=getSelection(),c=poset.permutation.indexOf(u);return!isNaN(u)&&c>=0&&(s===u||a===poset.permutation[c])&&(d=!1),d?hover.length>0&&(hover=[],!0):(hover=[s,l],!0)}function selectU(e){if(isBusy)return;if(0===e)return;let t=getSelection();isNaN(t)&&e>0&&setSelection(0),isNaN(t)&&e<0&&setSelection(poset.count()-1),isNaN(t)||setSelection(t+e)}function selectV(e){if(isBusy)return;if(0===e)return;let t=getSelection(),n=poset.count();if(isNaN(t)&&e>0&&setSelection(poset.permutation[0]),isNaN(t)&&e<0&&setSelection(poset.permutation[n-1]),isNaN(t))return;let r=poset.permutation.indexOf(t);if(r<0&&e<0||r>=n&&e>0)return;let i=r+e;setSelection(i<0||i>=n?NaN:poset.permutation[i])}function moveU(e){if(!isBusy)try{if(0===e)return;let t=getSelection();if(isNaN(t))return;setSelection(poset.moveU(t,e)),addUndoStep()}catch(e){showError(e.message,e instanceof WarningError)}}function moveV(e){if(!isBusy)try{if(0===e)return;let t=getSelection();if(isNaN(t))return;poset.moveV(t,e),setSelection(t),addUndoStep()}catch(e){showError(e.message,e instanceof WarningError)}}function changeOffset(e){if(isBusy)return;if(0==e)return;let t=getSelection();poset.offset=poset.offset+e,updateSelectionBounds(),isNaN(t)?(redrawPoset(),updateExport()):setSelection(t)}function changeOffsetAndUnselect(e){isBusy||(0!=e&&(poset.offset=poset.offset+e,updateSelectionBounds()),setSelection(NaN))}function addElement(){if(!isBusy)try{poset.pushNewElement(),hover=[],updateSelectionBounds(),setSelection(poset.count()-1),addUndoStep()}catch(e){showError(e.message,e instanceof WarningError)}}function dublicateElement(e){if(!isBusy)try{let t=getSelection();if(isNaN(t))return;e?poset.insert(t,getPredefined_chain(2)):poset.insert(t,getPredefined_antichain(2)),hover=[],updateSelectionBounds(),setSelection(t+1),addUndoStep()}catch(e){showError(e.message,e instanceof WarningError)}}function removeElement(){if(!isBusy)try{let e=getSelection(),t=poset.count();if(isNaN(e)||e<0||1===t)return;poset.removeElement(e),hover=[],updateSelectionBounds(),setSelection(Math.min(e,t-1)),addUndoStep()}catch(e){showError(e.message,e instanceof WarningError)}}function changeLink(){if(!isBusy)try{let e=getSelection(),t=getLinkingSelection();if(isNaN(e)||isNaN(t))return;poset.links[e].includes(t)?poset.removeLink(e,t):poset.isLinkable(e,t)&&poset.addLink(e,t),linkable=poset.isLinkable(e,t),redrawPoset(),updateExport(),addUndoStep()}catch(e){showError(e.message,e instanceof WarningError)}}function swapLeft(){if(!isBusy)try{let e=getSelection();if(isNaN(e))return;let t=poset.permutation.indexOf(e);if(t<0||t>=poset.count()-1)return;let n=e-1;if(poset.permutation[t+1]!=n)return;for(let t=0;t<e;t++)swapLinks(poset.links[t],e,n),swapLinks(poset.removedlinks[t],e,n),swapLinks(poset.addedlinks[t],e,n);swapElementPair(poset.links,e,n),swapElementPair(poset.removedlinks,e,n),swapElementPair(poset.addedlinks,e,n),setSelection(n),addUndoStep()}catch(e){showError(e.message,e instanceof WarningError)}}function to2Order(){isBusy||document.getElementById("frmExport_pcauset").hidden&&(poset.resetLinks(!0),setLinkingSelection(NaN),updateExport(),addUndoStep())}function turnOpposite(){if(isBusy)return;const e=poset.permutation.slice();let t=getSelection(),n=NaN,r=poset.count();for(let i=r;i>0;i--){let o=poset.permutation[r-i];e[r-o-1]=i-1,o===t&&(n=i-1)}poset.permutation=e,poset.remapLinks(e.toReversed()),hover=[],setSelection(n)}function reflect(){if(isBusy)return;const e=poset.permutation.slice();let t=getSelection(),n=NaN,r=poset.count();for(let i=0;i<r;i++){let r=poset.permutation[i];e[r]=i,r===t&&(n=i)}poset.permutation=e,poset.remapLinks(e),hover=[],setSelection(n)}function revise(){if(isBusy)return;let e=poset.getPermutationString();if(""==e)return;const t=document.getElementById("txtInputPermutation");t.value=e;let n="pcauset",r=strAllRemovedLinks,i=poset.getAddedLinksStringAndCount();i[1]>0&&(r=r.length>0?r+","+i[0]:i[0]),r.length>0&&(n="rcauset"),document.getElementById("selInputType").value=n,document.getElementById("txtInputRemovedLinks").value=r,document.getElementById("txtInputLinks").value=strAllLinks,selectInputType(),window.location.href="#import",t.focus()}function copyToClipboard(e){let t=document.getElementById(e).value;navigator.clipboard.writeText(t)}function updateSettingsButton(e,t,n){let r=!1;"ShowLabels"==e?(n&&(isShowingLabels=!isShowingLabels),r=isShowingLabels):"ShowCross"==e?(n&&(isShowingCross=!isShowingCross),r=isShowingCross):"ShowGrid"==e&&(n&&(isShowingGrid=!isShowingGrid),r=isShowingGrid),document.getElementById("but"+e).className="btn btn-sm btn-light"+(r?" active":""),t&&redrawPoset()}function updateExport(){hideLastError();let e=getSelection(),t=document.getElementById("selExportLatexStyle").value,n=poset.getPermutationString(),r=poset.getRemovedLinksStringAndCount(),i=poset.getAddedLinksStringAndCount(),o=poset.getLinksStringAndCount(),s=poset.countLayers(),l=poset.count();const a=document.getElementById("lblPermutation"),d=document.getElementById("txtPermutation");isNaN(e)?(a.innerHTML=l.toString()+(1==l?" element ":" elements ")+"on "+s.toString()+(1==s?" layer:":" layers:"),d.value=n):(a.innerHTML="1 of "+l.toString()+(1==l?" element ":" elements ")+"selected:",d.value=getElementString(e));const u=document.getElementById("lblLinks"),c=document.getElementById("txtLinks");if(strAllLinks=o[0],isNaN(e))u.innerHTML=o[1].toString()+(1==o[1]?" link:":" links:"),c.value=o[0];else{let t=findCoveredElements(poset.links,e);t.sort(function(e,t){return e-t});let n=poset.links[e];n.sort(function(e,t){return e-t}),u.innerHTML=t.length.toString()+" and "+n.length.toString()+" linked elements:",c.value="{"+t.map(getElementString).join(",")+"} and {"+n.map(getElementString).join(",")+"}"}const m=document.getElementById("lblRemovedLinks"),g=document.getElementById("txtRemovedLinks");if(strAllRemovedLinks=r[0],isNaN(e)){let e=l-s,t=0;l<=5||e<3?t=r[1]:e<5&&(t=r[1]-2),t>0?(m.className="input-group-text alert-danger",m.innerHTML=(t<r[1]?"At least ":"")+t.toString()+" of "+r[1].toString()+" too many removed links:"):(m.className="input-group-text",m.innerHTML=r[1].toString()+" removed"+(1==r[1]?" link:":" links:")),g.value=strAllRemovedLinks}else{let t=findCoveredElements(poset.removedlinks,e);t.sort(function(e,t){return e-t});let n=poset.removedlinks[e];n.sort(function(e,t){return e-t}),m.innerHTML=t.length.toString()+" and "+n.length.toString()+" unlinked elements:",g.value="{"+t.map(getElementString).join(",")+"} and {"+n.map(getElementString).join(",")+"}"}let h=strAllRemovedLinks;i[0].length>0&&(h=h+","+i[0]),document.getElementById("txtExport_pcauset").value="\\pcauset"+t+"{"+n+"}",document.getElementById("txtExport_rcauset").value="\\rcauset"+t+"{"+n+"}{"+h+"}",document.getElementById("txtExport_causet").value="\\causet"+t+"{"+n+"}{"+o[0]+"}";let p=0==h.length;document.getElementById("butOptimize").disabled=2!=s,document.getElementById("butTo2Order").disabled=p,document.getElementById("frmExport_pcauset").hidden=!p,document.getElementById("frmExport_rcauset").hidden=p,document.getElementById("frmExport_causet").hidden=p,setExportArrayButtonBusyState(!1),document.getElementById("txtExportArray").value=""}function addExportArrayLine_linkmatrix(){exportArray_lines[exportArray_index]=poset.getLinkMatrixRow(exportArray_index).map(Number).join(","),nextExportArrayLine(addExportArrayLine_linkmatrix)}function addExportArrayLine_ordermatrix(){let e=exportArray_lines.length-1-exportArray_index,t=poset.getLinkMatrixRow(e),n=poset.links[e];for(let e=0;e<n.length;e++){let r=exportArray_matrix[n[e]];for(let e=0;e<t.length;e++)t[e]=t[e]||r[e]}exportArray_matrix[e]=t,exportArray_lines[e]=t.map(Number).join(","),nextExportArrayLine(addExportArrayLine_ordermatrix)}function addExportArrayLine_coveringrelations(){let e=findCoveredElements(poset.links,exportArray_index);e.sort(function(e,t){return e-t}),exportArray_lines[exportArray_index]=getElementString(exportArray_index)+": "+e.map(getElementString).join(","),nextExportArrayLine(addExportArrayLine_coveringrelations)}function addExportArrayLine_coveredbyrelations(){let e=poset.links[exportArray_index].slice();e.sort(function(e,t){return e-t}),exportArray_lines[exportArray_index]=getElementString(exportArray_index)+": "+e.map(getElementString).join(","),nextExportArrayLine(addExportArrayLine_coveredbyrelations)}function nextExportArrayLine(e){if(isBusy){if(exportArray_index+=1,exportArray_index<exportArray_lines.length)return stepProgress(exportArray_index/exportArray_lines.length),void setTimeout(e,0);document.getElementById("txtExportArray").value=exportArray_lines.join("\n"),setExportArrayButtonBusyState(!1),finishProgress()}}function setExportArrayButtonBusyState(e){const t=document.getElementById("butExportArray");e?(t.className="btn btn-danger mb-2",t.innerHTML="Cancel"):(t.className="btn btn-secondary mb-2",t.innerHTML="Compute")}function getExportArray(){if(!poset)return;if(isBusy)return setExportArrayButtonBusyState(!1),void finishProgress();switch(setExportArrayButtonBusyState(!0),startProgress(),exportArray_index=0,exportArray_lines=new Array(poset.count()),exportArray_matrix=new Array(poset.count()),document.getElementById("selExportArrayType").value){case"linkmatrix":return void addExportArrayLine_linkmatrix();case"ordermatrix":return void addExportArrayLine_ordermatrix();case"coveringrelations":return void addExportArrayLine_coveringrelations();case"coveredbyrelations":return void addExportArrayLine_coveredbyrelations()}document.getElementById("txtExportArray").value="Not implemented."}function memorize(){if(isBusy||!poset)return;let e;e=document.getElementById("frmExport_pcauset").hidden?document.getElementById("txtExport_rcauset").value:document.getElementById("txtExport_pcauset").value;const t=document.createElement("option");t.value=e;let n=poset.count(),r=poset.countLinks();t.innerHTML=n.toString()+(1==n?" element":" elements")+", "+r.toString()+(1==r?" link":" links")+", "+e,t.selected=!0,document.getElementById("selInputMemory").appendChild(t),disableMemoryTools(!1),document.getElementById("selInputType").value="memory",selectInputType()}function disableMemoryTools(e=!0){document.getElementById("butRemoveMemoryEntry").disabled=e,document.getElementById("butClearMemory").disabled=e,document.getElementById("butCopyMemoryEntry").disabled=e,document.getElementById("butCopyMemory").disabled=e}function removeMemoryEntry(){if(isBusy)return;if(!WarningError_isShowing)return showError("Removing a poset from this memory list cannot be undone! Push the button again to continue.",!0),void(WarningError_isShowing=!0);hideLastError();const e=document.getElementById("selInputMemory");for(let t=0;t<e.children.length;t++)if(e.children.item(t).selected){e.children.item(t).remove();break}0!=e.children.length?e.children.item(0).selected=!0:disableMemoryTools()}function clearMemory(){if(!isBusy){if(!WarningError_isShowing)return showError("Clearing the poset memory list cannot be undone! Push the button again to continue.",!0),void(WarningError_isShowing=!0);hideLastError(),document.getElementById("selInputMemory").innerHTML="",disableMemoryTools()}}function copyMemoryEntry(){let e=document.getElementById("selInputMemory").value;navigator.clipboard.writeText(e)}function copyMemory(){const e=document.getElementById("selInputMemory");let t="";for(let n=0;n<e.children.length;n++)n>0&&(t+="\n"),t+=e.children.item(n).value;navigator.clipboard.writeText(t)}function handleHover(e){isBusy||updateHoveredTile(e.clientX,e.clientY)&&redrawPoset()}function handleClick(e){if(isBusy)return;let t=e.clientX,n=e.clientY;if(updateHoveredTile(t,n),0==hover.length){let e=document.getElementById("cnvPoset").getBoundingClientRect();return void(e.left<t&&t<e.right&&e.top<n&&n<e.bottom&&setSelection(NaN))}let r=hover[0],i=poset.permutation[hover[1]],o=getSelection(),s=getLinkingSelection();if(r===i)return isNaN(o)||(linkable=poset.isLinkable(o,r),0==linkable||!isNaN(s)&&s==r)?void setSelection(r):(document.getElementById("butLink").disabled=!1,void setLinkingSelection(r));if(isNaN(o))return;if(o!=r)return void moveU(r-o);let l=poset.permutation.indexOf(o);moveV(hover[1]-l)}function handleDoubleClick(e){if(isBusy)return;if(updateHoveredTile(e.clientX,e.clientY),0==hover.length)return;hover[0]===poset.permutation[hover[1]]&&dublicateElement(e.shiftKey)}function handleKeyDown(e){isBusy||document.activeElement&&document.activeElement.id.startsWith("txt")||e.altKey||e.metaKey||(!e.shiftKey&&e.ctrlKey&&"z"==e.key&&resetToUndoStep(-1),(!e.shiftKey&&e.ctrlKey&&"y"==e.key||e.shiftKey&&e.ctrlKey&&"Z"==e.key)&&resetToUndoStep(1),e.ctrlKey||(e.shiftKey?"KeyA"==e.code?moveU(-1):"KeyD"==e.code?moveU(1):"KeyS"==e.code?moveV(-1):"KeyW"==e.code&&moveV(1):"KeyA"==e.code?selectU(-1):"KeyD"==e.code?selectU(1):"KeyS"==e.code?selectV(-1):"KeyW"==e.code?selectV(1):"Delete"==e.key?removeElement():"."==e.key&&addElement()))}function handleResize(){isBusy||updateWidth()&&redrawPoset()}function getFromCoveringList(t){let n=t.split("\n"),r=[],i=[],o=0,s=0,l=0,a=0,d=0;for(let t=0;t<n.length;t++){let u=n[t].trim();if(0==u.length){d+=1;continue}if(u.includes(":"))throw new SyntaxError("An explicit labelling of the second layer elements is not supported! The second layer elements are automatically labelled starting with the next larger number of all numbers in the text field. Do not use the colon character!");let c=u.split(",").map(parseIntNotNaN),m=[];for(let t=0;t<c.length;t++)e=c[t],(0==i.length||e<o)&&(o=e),(0==i.length||e>s)&&(s=e),i.includes(e)||i.push(e),m.includes(e)||m.push(e);0!=m.length&&(a+=1,l+=m.length,r.push(m))}
if(0==r.length){if(0==d)throw new SyntaxError("The list of coverings is empty!");return getPredefined_antichain(d)}let u=s-o+1;if(u!=i.length){let e=[],t=!1;for(let n=0;n<u;n++)if(!i.includes(o+n)){if(t=e.length>=5,t)break;e.push(o+n)}throw new SyntaxError("The"+(1==e.length?" element ":" elements ")+e.join(", ")+(t?" and more ":"")+(1==e.length?" is ":" are ")+"missing in the list of coverings!")}return a=a+u+d,checkAndThrowWarningIfLarge(a),checkAndThrowWarningIfLarge(l,!0),convertCoveringsToPoset(r,o,u,d)}function getRearrangementMoveBounds(e,t,n){const r=initializeArray(n,0);for(let i=1;i<n;i++){let n=t+i;for(let t=0;t<e.length;t++)if(e[t].includes(n)){r[i]=t;break}}const i=initializeArray(e.length,0);for(let r=1;r<e.length;r++)for(let o=0;o<n;o++){let n=t+o;if(e[r].includes(n)){i[r]=o;break}}return[r,i]}function getLayeredPermutation(e,t,n,r,i=!1,o=0){let s=new Array(t+n+r);return getLayeredPermutation_setRange(s,t,r,e,t-1,i,o),getLayeredPermutation_setRange(s,n,r+t,e,t+n-1,i,o),getLayeredPermutation_setRange(s,r,0,e,s.length-1,!1,0),s}function getLayeredPermutation_setRange(e,t,n,r,i,o,s){if(o)for(let o=0;o<t;o++)e[o+n]=s[i-o]+r;else for(let o=0;o<t;o++)e[o+n]=i-o+r}function convertCoveringsToPoset(e,t,n,r,i=!0){const o=new Array(n+e.length);for(let e=0;e<o.length;e++)o[e]=e;let s=[],l=0;if(i){s=getRearrangementMoveBounds(e,t,n),l=s[0][n-1];for(let e=n-1;e>=0&&0!=l;e--){let t=Math.min(s[0][e],l);o[e]=o[e]+t;for(let e=n;e<n+t;e++)o[e]=o[e]-1;l=t}}r<0&&(r=0);let a=getLayeredPermutation(t,n,e.length,r,i,o);if(i){l=s[1][e.length-1];for(let r=e.length-1;r>=0&&0!=l;r--){let e=Math.min(s[1][r],l),i=o[n+r]+t,d=a.indexOf(i);a=a.slice(0,d-e).concat([i],a.slice(d-e,d),a.slice(d+1)),l=e}}const d=[];for(let r=0;r<e.length;r++){let i=e[r],s=o[r+n]+t;for(let e=0;e<i.length;e++){let n=o[i[e]-t]+t;d.push([n,s])}}return new Poset(a,d,!1)}function countLayeredAntichains(e){let t=e.length;if(0==t)return 0;let n=e[0],r=1;for(let i=1;i<t;i++){let t=n-1,o=e[i];if(o<t)return 0;o>t&&(r+=1),n=o}return r}function getCoveringsAndAntichain(){const e=poset.findMinimalElements(),t=poset.findMaximalElements(),n=[],r=[];for(let t=0;t<e.length;t++){let i=e[t];0==poset.links[i].length?r.push(i):n.push(i)}const i=[];for(let e=0;e<t.length;e++){let o=t[e];if(r.includes(o))continue;let s=[];for(let e=0;e<n.length;e++)poset.links[n[e]].includes(o)&&s.push(e);i.push(s)}return[i,n.length,r.length]}function optimize(){if(!isBusy)try{if(2!=poset.countLayers())return;let e=poset.offset,t=getCoveringsAndAntichain(),n=t[1],r=t[2];getLayeredPermutation(0,n,t[0].length,r).toString()!=poset.permutation.toString()&&(poset=convertCoveringsToPoset(t[0],0,n,r,!1),changeOffsetAndUnselect(e),addUndoStep());const i=[0,poset.permutation[r]+1],o=[i[1],poset.count()-r-i[1]];let s=poset.links.slice(0,i[1]);const l=findLinkCrossingMinimum(s,i,o,countLinkCrossings(s),!0);poset=convertCoveringsToPoset(l[0],i[0],o[0],r,!0),changeOffsetAndUnselect(e),addUndoStep()}catch(e){showError(e.message,e instanceof WarningError)}}function findLinkCrossingMinimum(e,t,n,r,i=!1){let o=0,s=0;for(;s<2;){let i=reduceLinkCrossings(e,r);i<r?(r=i,s=0):s+=1,o+=1,e=oppositeLinkings(e,t[(o+1)%2],t[o%2],n[o%2])}return(i&&o%2==0||!i&&o%2!=0)&&(e=oppositeLinkings(e,t[o%2],t[(o+1)%2],n[(o+1)%2])),[e,r]}function oppositeLinkings(e,t,n,r){const i=initializeLinkList(r);for(let r=0;r<e.length;r++){let o=e[r];for(let e=0;e<o.length;e++)i[o[e]-n].push(r+t)}return i}function swapElementPair(e,t,n){let r=e[t];e[t]=e[n],e[n]=r}function swapLinks(e,t,n){for(let r=0;r<e.length;r++)e[r]==t?e[r]=n:e[r]==n&&(e[r]=t)}function reduceLinkCrossings(e,t){if(0==t)return t;for(let n=0;n<e.length;n++)for(let r=n+1;r<e.length;r++){swapElementPair(e,n,r);let i=countLinkCrossings(e);if(i>=t)swapElementPair(e,n,r);else if(0==(t=i))return t}return t}function countLinkCrossings(e){let t=0;for(let n=1;n<e.length;n++){let r=e[n];for(let i=0;i<n;i++){let n=e[i];for(let e=0;e<n.length;e++)for(let i=0;i<r.length;i++)n[e]>r[i]&&t++}}return t}let isBusy=!1;const LargePosetWarning_elements=250,LargePosetWarning_links=2e3;let WarningError_isShowing=!1,LargePosetWarningError_isShowing=!1;class WarningError extends Error{constructor(e){super(e),WarningError_isShowing=!0,this.name="Warning",this.message=e+" \nRepeat the action to ignore this warning."}}class LargePosetWarningError extends WarningError{constructor(e,t=!1){let n="You are about to generate a poset with "+e;n+=t?" links. ":" elements. ",super(n+"Handling large posets can slow down your system!"),LargePosetWarningError_isShowing=!0}}let poset,isShowingLabels=!1,isShowingCross=!0,isShowingGrid=!1,strAllLinks="",strAllRemovedLinks="";class Poset{constructor(e,t,n,r=!0){this.error="",this.hasWarning=!1;try{const t=parsePermutation(e,r);this.permutation=t[0],this.offset=t[1]}catch(e){return this.error=e.toString(),void(this.hasWarning=e instanceof WarningError)}this.resetLinks(n);try{const e=parseLinks(t,this.offset,this.count()-1);let i=e[0];if(n)for(let e=0;e<i.length;e++)this.removeLink(i[e][0],i[e][1]);else for(let e=0;e<i.length;e++)this.addLink(i[e][0],i[e][1]);i=e[1];for(let e=0;e<i.length;e++)this.addLink(i[e][0],i[e][1],n);let o=this.countLinks();r&&checkAndThrowWarningIfLarge(o,!0)}catch(e){return this.error=e.toString(),void(this.hasWarning=e instanceof WarningError)}}count(){return this.permutation.length}resetLinks(e){let t=this.count();this.autolinks=initializeLinkList(t),this.removedlinks=initializeLinkList(t),this.addedlinks=initializeLinkList(t),this.links=initializeLinkList(t);for(let n=0;n<t;n++){let r=this.permutation[n],i=t;for(let o=n+1;o<t;o++){let t=this.permutation[o];r<t&&t<i&&(this.autolinks[r].push(t),e?this.links[r].push(t):this.removedlinks[r].push(t),i=t)}}}remapLinks(e){this.autolinks=remapLinkList(this.autolinks,e),this.removedlinks=remapLinkList(this.removedlinks,e),this.addedlinks=remapLinkList(this.addedlinks,e),this.links=remapLinkList(this.links,e)}isOrdered(e,t){if(this.links[e].includes(t))return!0;const n=new Array(t-e+1);n[0]=!0,n[t-e]=!1;for(let r=e;r<t;r++){if(!n[r-e])continue;let i=this.links[r];for(let o=0;o<i.length;o++)i[o]<r||i[o]>t||(n[i[o]-e]=!0)}return n[t-e]}countLinks(){let e=0,t=this.count();for(let n=0;n<t;n++)e+=this.links[n].length;return e}findMinimalElements(){let e=this.count();const t=initializeArray(e,!0);for(let n=0;n<e;n++){let e=this.links[n];for(let n=0;n<e.length;n++)t[e[n]]=!1}const n=[];for(let r=0;r<e;r++)t[r]&&n.push(r);return n}findMaximalElements(){let e=this.count();const t=[];for(let n=0;n<e;n++)0==this.links[n].length&&t.push(n);return t}getLayerIndices(){const e=initializeArray(this.count(),1);for(let t=0;t<e.length;t++){let n=this.links[t],r=e[t]+1;for(let t=0;t<n.length;t++){let i=n[t];r>e[i]&&(e[i]=r)}}return e}countLayers(){let e=this.getLayerIndices(),t=0;for(let n=0;n<e.length;n++)e[n]>t&&(t=e[n]);return t}removeLink(e,t,n=!1){if(e>t)return void this.removeLink(t,e,n);if(e===t){if(n)return;throw new ReferenceError("An element cannot be unlinked from itself.")}let r=this.links[e].indexOf(t);if(-1===r){if(n)return;throw new ReferenceError("The element "+e.toString()+" is not linked to "+t.toString()+".")}this.links[e].splice(r,1),r=this.addedlinks[e].indexOf(t),r>-1&&this.addedlinks[e].splice(r,1),this.autolinks[e].includes(t)&&this.removedlinks[e].push(t)}addLink(e,t,n=!1){if(e>t)return void this.addLink(t,e,n);if(e===t){if(n)return;throw new ReferenceError("An element cannot be linked to itself.")}if(this.links[e].includes(t)){if(n)return;throw new ReferenceError("The element "+e.toString()+" already covers "+t.toString()+".")}for(let n=0;n<=e;n++){for(let r=this.addedlinks[n]-1;r>=0;r--){let i=this.addedlinks[n][r];t<=i&&(n===e||this.isOrdered(n,e))&&(t===i||this.isOrdered(t,i))&&this.removeLink(n,i,!0)}}let r=this.removedlinks[e].indexOf(t);r>-1&&this.removedlinks[e].splice(r,1),this.links[e].push(t),this.autolinks[e].includes(t)||this.addedlinks[e].push(t)}isLinkable(e,t){if(t<=e)return 0;let n=this.permutation.indexOf(e);return this.permutation.indexOf(t)<=n?0:this.links[e].includes(t)?0==this.links[e].length||0==findCoveredElements(this.links,t).length?0:-1:this.isOrdered(e,t)?0:1}pushNewElement(){let e=this.count();checkAndThrowWarningIfLarge(e+1),this.permutation.unshift(e),this.autolinks.push([]),this.removedlinks.push([]),this.addedlinks.push([]),this.links.push([])}reset_restoreLinks(e,t){let n=this.removedlinks,r=this.addedlinks,i=findCoveredElements(this.links,e),o=this.links[e];this.resetLinks(!0),this.restoreLinks(n,!1,e,t,i,o),this.restoreLinks(r,!0,e,t,i,o)}restoreLink(e,t,n){let r=this.isLinkable(e,t);n&&1==r?this.addLink(e,t,!0):n||-1!=r||this.removeLink(e,t,!0)}restoreLinks(e,t,n,r,i,o){const s=[];for(let i=0;i<e.length;i++){let o=i-(i>n)+(i>r)+(i==r&&n>r);if(i==n){if(isNaN(r))continue;o=r}let l=e[i];for(let e=0;e<l.length;e++){let a=l[e],d=a-(a>n)+(a>r)+(a==r&&n>r);if(a==n){if(s.push(i),isNaN(r))continue;d=r}this.restoreLink(o,d,t)}}for(let e=0;e<s.length;e++){let n=s[e];for(let e=0;e<o.length;e++){let i=o[e];this.restoreLink(n+(n>=r),i-1+(i>=r),t)}}const l=e[n];for(let e=0;e<i.length;e++){let n=i[e];for(let e=0;e<l.length;e++){let i=l[e];this.restoreLink(n+(n>=r),i-1+(i>=r),t)}}}removeElement(e){let t=this.count();if(e<0||e>=t)throw new RangeError("There is no element "+getElementString(e)+".");let n=this.permutation.indexOf(e);this.permutation.splice(n,1);for(let n=0;n<t;n++)this.permutation[n]>e&&(this.permutation[n]=this.permutation[n]-1);this.reset_restoreLinks(e,NaN)}insert(e,t){let n=this.count(),r=t.count();if(e<0||e>=n)throw new RangeError("The insert position "+getElementString(e)+" is out of range.");checkAndThrowWarningIfLarge(n+r);let i=this.permutation.indexOf(e),o=t.findMinimalElements(),s=t.findMaximalElements();raiseElements(this.permutation,e+1,r-1),raiseElements(t.permutation,0,e),this.permutation=this.permutation.slice(0,i).concat(t.permutation,this.permutation.slice(i+1)),raiseElements(o,0,e),raiseElements(s,0,e),this.autolinks=insertLinks(this.autolinks,e,t.autolinks,o,s),this.removedlinks=insertLinks(this.removedlinks,e,t.removedlinks,o,s),this.addedlinks=insertLinks(this.addedlinks,e,t.addedlinks,o,s),this.links=insertLinks(this.links,e,t.links,o,s)}moveU(e,t){if(0==t)return e;let n=this.count();if(e<0||e>=n)throw new RangeError("There is no element "+getElementString(e)+".");let r=e+t;if(r<0||r>=n)throw new RangeError("The new position lies outside the diagram.");let i=this.permutation.indexOf(e),o=t>0?1:-1;for(let t=e+o;o*(r-t)>=0;t+=o){let e=this.permutation.indexOf(t);this.permutation[e]=t-o}return this.permutation[i]=r,this.reset_restoreLinks(e,r),r}moveV(e,t){let n=this.permutation.indexOf(e);if(0==t)return n;let r=this.count();if(e<0||e>=r)throw new RangeError("There is no element "+getElementString(e)+".");let i=n+t;if(i<0||i>=r)throw new RangeError("The new position lies outside the diagram.");let o=e;return this.permutation.splice(i,0,this.permutation.splice(n,1)[0]),this.reset_restoreLinks(e,o),i}getLinkMatrixRow(e){let t=this.links[e],n=initializeArray(this.count(),!1);for(let e=0;e<t.length;e++)n[t[e]]=!0;return n}toLinkMatrix(){let e=this.count(),t=new Array(e);for(let n=0;n<e;n++)t[n]=this.getLinkMatrixRow(n);return t}toOrderMatrix(){let e=this.count(),t=this.toLinkMatrix();for(let n=0;n<e;n++)for(let r=n+1;r<e;r++)if(t[n][r])for(let i=r+1;i<e;i++)t[n][i]=t[n][i]||t[r][i];return t}getPermutationString(){return this.permutation.map(getElementString).join(",")}get_LinksStringAndCount(e,t){let n="",r=0;for(let i=0;i<e.length;i++){if(0===e[i].length)continue;let o=getElementString(i)+"/";n.length>0&&(n+=","),n=n+o+e[i].map(t).join(","+o),r+=e[i].length}return[n,r]}getRemovedLinksStringAndCount(){return this.get_LinksStringAndCount(this.removedlinks,getElementString)}getAddedLinksStringAndCount(){return this.get_LinksStringAndCount(this.addedlinks,getAddedLinkTargetString)}getLinksStringAndCount(){return this.get_LinksStringAndCount(this.links,getElementString)}}let hover=[],linkable=0;const event_size=.25,link_width=.08,linking_width=.14,event_hover_size=.33,event_linking_size=.17,selection_color="red",selection_cross_color="#ffe6e6",relocation_color="#30a070",event_color="black",event_hover_color="#703030",event_linking_color="#007bff",unlinked_color="#d0ebff",link_color="#6c757d",undosteps_max=100;let exportArray_index,exportArray_lines,exportArray_matrix,undosteps=[],undoindex=-1;window.addEventListener("mousemove",handleHover),window.addEventListener("click",handleClick),window.addEventListener("dblclick",handleDoubleClick),window.addEventListener("keydown",handleKeyDown),window.addEventListener("resize",handleResize);